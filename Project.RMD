---
title: "Project One"
author: "Jason Burk"
date: "10/26/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!-- Project One -->


```{r}
# Install libraries

4
```


# **Questions:**
# **==============================================**

##  **1.   How many breweries are present in each state? **


*To find the number of breweries in each state we had to import that data from the given .CSV files and then merge them in R.  Once merged we were able to sum up the number of breweries by state.*

```{r}
# read in the beer data from a .CSV
beers = read.csv("~/03-School/DS 6306/Project-1/Project-One/Beers.csv")

# read in the brewery data from a .CSV
breweries = read.csv("~/03-School/DS 6306/Project-1/Project-One/Breweries.csv")

# combine the beer and brewery data using the brewery ID as the key
combine = merge(beers, breweries, by.x = "Brewery_id", by.y = "Brew_ID")

# change the names of the column headers to match
names(combine)[names(combine) == "Name.x"] <- "Beer_Name"
names(combine)[names(combine) == "Name.y"] <- "Brewery_Name"

# compute the sum of the breweries by state
statesum = count(breweries, vars = State)
```

##  **2.   Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.**  


*We merged the beer and brewery data in the previous set of code. Now in order to print the first 6 observations we use the command "head" and it gives us the data for the first 6 observations.  Using the command "tail" will give us the last 6 observations*


```{r}
# find the first 6 and last 6 beers
head(combine)
tail(combine)
```

##  **3.   Address the missing values in each column.**


*In order to address the missing values in each column we turned to a function available in the R code libraries.  A function called Multivariate Imputaton by Chained Equations (MIcE).  We were able to infer values for Alcohol by Volume (ABV) and International Bitterness Units (IBU) where the data was missing.*

```{r}
# No iteration. But I want to get Predictor-Matrix
# init = mice(combine, maxit=0) 
# predM = init$predictorMatrix
# 
# # Do not use following columns to impute values in 'ABV' and 'IBU'. Use the rest.
# predM[, c("Beer_Name", "Beer_ID", "Ounces", "Brewery_Name")]=0    
# imp<-mice(combine, m=5, predictorMatrix = predM)
# 
# # Get the final data-frame with imputed values filled in
# nona <- complete(imp)

#write.csv(nona, file = "~/03-School/DS 6306/Project-1/Project-One/nona.csv")
nona = read.csv("~/03-School/DS 6306/Project-1/Project-One/nona.csv")
```

##  **4.   Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.**  


*We were able to compute the median ABV and IBU for each state by incorporating another library available in R. There is a data frame called State Population that contains the abbreviations and state names (and 2015 Census data).  We were able to merge the beer data and count the number of breweries by each state - including the District of Columbia.*

```{r}
# merge datasets for plotting on maps
temp = statepop
statesum$vars = as.character(statesum$vars)
statesum$vars = str_trim(statesum$vars)
statebrew = merge(statesum, temp, by.x = "vars", by.y = "abbr")
names(statebrew)[names(statebrew) == "vars"] <- "abbr"
names(statebrew)[names(statebrew) == "n"] <- "count"
statebrew$per_cap <- statebrew$pop_2015 / statebrew$count

#  plot of the Number of Beers by State
plot_usmap(data = statebrew, values = "count", color = "red") + 
  scale_fill_continuous(name = "Breweries", label = scales::comma) + labs(title = "Number of Breweries all 50 States") + theme(legend.position = "right")

# remove n/a's from the data
nona$State = as.character(nona$State)
nona$State = str_trim(nona$State)

# merge data to one master data frame
allbrews = merge(statebrew, nona, by.x = "abbr", by.y = "State")

# compute the ABV state stats
stateABV = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), ABV)

# compute the IBU state stats
stateIBU = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), IBU)

# Merge data files
stateABV = merge(temp, stateABV, by.x = "abbr", by.y = "abbr")
stateIBU = merge(temp, stateIBU, by.x = "abbr", by.y = "abbr")
stateABV$median = stateABV$median * 100

### ABV usa -->
plot_usmap(data = stateABV, values = "median", color = "red") + labs(title = "Median ABV by all 50 States", subtitle = "This is a map of the ABV by State.") + 
scale_fill_continuous( 
low = "white", high = "midnightblue", name = "Alcohol by Volume % by State"  ) + theme(legend.position = "right") 

### IBU usa -->
plot_usmap(data = stateIBU, values = "median", color = "red") + labs(title = "Median IBU by all 50 States", subtitle = "This is a map of the IBU by State.") + 
scale_fill_continuous( 
low = "white", high = "midnightblue", name = "IBU by State"  ) + theme(legend.position = "right")
```


##  **5.   Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?**   

```{r}
#### Max ABV
stateABV$max = stateABV$max * 100
stateABV$min = stateABV$min * 100
plot_usmap(data = stateABV, values = "max", include = "CO", color = "red") + labs(title = "Max ABV by State", subtitle = "This is a map of the State with the highest ABV") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by %"  ) + theme(legend.position = "right")

#### Max IBU
plot_usmap(data = stateIBU, values = "max", include = "CO", color = "red") + labs(title = "Max IBU by State", subtitle = "This is a map of the State with the highest IBU") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU"  ) + theme(legend.position = "right")
```


##  **6.   Comment on the summary statistics and distribution of the ABV variable.**  

```{r}
summary(stateABV$mean)
summary(allbrews$ABV)

nona%>%ggplot(aes(x="", y=ABV,fill=ABV))+geom_boxplot(width=.4,fill="blue")+ylab("ABV")+labs(title="Box plot of ABV Summary Statistics", caption = "Source: Brewery Statistics", x="", y="ABV")
```

##  **7.   Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.**

```{r}
#### Max ABV by state
plot_usmap(data = stateABV, values = "max", color = "red") + labs(title = "Median ABV by all 50 States", subtitle = "This is a map of the ABV by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "Alcohol by Volume by State"  ) + theme(legend.position = "right")

#### Max IBU by state
plot_usmap(data = stateIBU, values = "max", color = "red") + labs(title = "Median IBU by all 50 States", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State"  ) + theme(legend.position = "right")
```


##  **8.  Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN classification to investigate this relationship.  Provide statistical evidence one way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy to understand.**  
   
```{r}    
### IBU North east    
plot_usmap(include = .northeast_region, data = stateIBU, values = "median", color = "red") + labs(title = "North East Region", subtitle = "This is a map of the Median IBU by State.") + 
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State"  ) + theme(legend.position = "right")

### IBU North Central
plot_usmap(include = .north_central_region, data = allbrews, values = "IBU", color = "red") + labs(title = "North central Region", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State") + theme(legend.position = "right")

### IBU Mid-West Central
plot_usmap(include = .midwest_region, data = allbrews, values = "IBU", color = "red") + labs(title = "Mid-West Region", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State") + theme(legend.position = "right")

### IBU South Central
plot_usmap(include = .south_region, data = allbrews, values = "IBU", color = "red") + labs(title = "South Region", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State") + theme(legend.position = "right")

### IBU West Central
plot_usmap(include = .west_region, data = allbrews, values = "IBU", color = "red") + labs(title = "West Region", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU by State") + theme(legend.position = "right")



### ABV North east    
plot_usmap(include = .northeast_region, data = stateABV, values = "median", color = "red") + labs(title = "North East Region", subtitle = "This is a map of the Median ABV by State.") + 
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by State"  ) + theme(legend.position = "right")

### ABV North Central
plot_usmap(include = .north_central_region, data = allbrews, values = "ABV", color = "red") + labs(title = "North central Region", subtitle = "This is a map of the ABV by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by State") + theme(legend.position = "right")

### ABV Mid-West Central
plot_usmap(include = .midwest_region, data = allbrews, values = "ABV", color = "red") + labs(title = "Mid-West Region", subtitle = "This is a map of the ABV by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by State") + theme(legend.position = "right")

### ABV South Central
plot_usmap(include = .south_region, data = allbrews, values = "ABV", color = "red") + labs(title = "South Region", subtitle = "This is a map of the ABV by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by State") + theme(legend.position = "right")

### ABV West Central
plot_usmap(include = .west_region, data = allbrews, values = "ABV", color = "red") + labs(title = "West Region", subtitle = "This is a map of the ABV by State.") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV by State") + theme(legend.position = "right")

######################
temp = allbrews
allbrews=temp
######################


# find common beer styles for EDA
styles = c("IPA", "APA", "Blonde ale", "brown ale", "red ale", "ale", "lager", "stout", "cider", "porter", "pilsner", "hefeweizen" ,"pilsener", "witbier", "fruit", "KÃ¶lsch")
beers = data.frame(styles)
beers$nodata = 0
allbrews$class = ""
allbrews$used = FALSE
allbrews$Beer_Name = as.character(allbrews$Beer_Name)
beers$styles = as.character(beers$styles)
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(beers)[1]) {
    x = beers[j,]$style
    y = allbrews[i,]$Style
    if (str_detect(y, regex(x, ignore_case = TRUE)) & allbrews[i,]$used != TRUE) {
      allbrews[i,]$class = beers[j,]$style
      allbrews[i,]$used = TRUE
    }
  }
}
for (i in 1:dim(allbrews)[1]) {
  if (allbrews[i,]$used == FALSE) {
    allbrews[i,]$class = "other"
  }
  if (allbrews[i,]$class == "Pilsener" | allbrews[i,]$class == "pilsener") {
    allbrews[i,]$class = "pilsner"
  }
}    

# find the number of beers in each style    
stylesum = count(allbrews, vars = class)    
    

# compute the means for the ABV and IBU by style and then plot
stylemeans = stylesum
stylemeans$ABVmean = 0
stylemeans$IBUmean = 0
stylemeans$ABVtotal = 0
stylemeans$IBUtotal = 0
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(stylesum)[1]) {
  
    if (allbrews[i,]$class == stylesum[j,]$vars) {
      stylemeans[j,]$ABVtotal = stylemeans[j,]$ABVtotal + allbrews[i,]$ABV
      stylemeans[j,]$IBUtotal = stylemeans[j,]$IBUtotal + allbrews[i,]$IBU
    }
    
  }
}

for (j in 1:dim(stylemeans)[1]) {
  stylemeans[j,]$ABVmean = stylemeans[j,]$ABVtotal / stylemeans[j,]$n
  stylemeans[j,]$IBUmean = stylemeans[j,]$IBUtotal / stylemeans[j,]$n
}

stylemeans$ABVmean = round(stylemeans$ABVmean, 4)
stylemeans$IBUmean = round(stylemeans$IBUmean, 4)
names(stylemeans)[names(stylemeans) == "vars"] <- "abbr"
names(stylemeans)[names(stylemeans) == "n"] <- "count"


names(stylemeans)[names(stylemeans) == "abbr"] <- "Style"
# plot ABV vs IBU to see any relationships
gg <- ggplot(stylemeans, aes(x=ABVmean, y=IBUmean)) +
  geom_point(aes(col=Style, size=count)) +
  labs(subtitle="ABV vs IBU",
       y="IBU",
       x="ABV",
       title="Beer Style ABV vs IBU",
       caption = "Source: Brewery Data")

plot(gg)
```



##  **9. Knock their socks off!  Find one other useful inference from the data that you feel Budweiser may be able to find value in.  You must convince them why it is important and back up your conviction with appropriate statistical evidence.** 

```{r}
# <!-- justABV<-nona%>%select(ABV) -->
# <!-- summary(justABV) -->
# <!-- hist(justABV$ABV, -->
# <!--     main="Histogram of Alcohol by Volume of beer population", -->
# <!--     xlab="Alcohol by Volume", -->
# <!--     ylab="Beer population", -->
# <!--     col="blue", -->
# <!--     border="black" -->
# <!--     ) -->
# <!-- nona%>%ggplot(aes(x=ABV,fill=State))+geom_histogram(bins=30)+ggtitle("Alcohol by Volume Distribution of Beer population")+xlab("ABV Content")+ylab("Number of Beers")#1 sample t-test of ABV data -->
# <!-- logjustABV<-log(justABV) -->
# <!-- t.test(x=justABV, conf.int = "TRUE", alternative = "two.sided") -->
# 
# <!-- justIBU<-nona%>%select(IBU) -->
# <!-- hist(justIBU$IBU, -->
# <!--     main="Histogram of International Bitternes Units of beer population", -->
# <!--     xlab="International Bitternes Units", -->
# <!--     ylab="Beer population", -->
# <!--     col="blue", -->
# <!--     border="black" -->
# <!--     ) -->
# <!-- nona%>%ggplot(aes(x=IBU,color=State))+geom_histogram(bins=30)+ggtitle("Distribution of Bitterness of Beer population")+xlab("Bitterness")+ylab("Number of Beers") -->





styleSubset <- nona%>%select(Style,ABV,IBU)
beermatch <- c("IPA","Ale","Inda Pale Ale")
allAles <-styleSubset[grep(paste(beermatch,collapse="|"),styleSubset$Style,ignore.case = TRUE),]

allAles$styleClass <- ifelse(grepl("IPA", allAles$Style,ignore.case = T), "IPA",
         ifelse(grepl("Ale", allAles$Style, ignore.case = T), "Ale", "Other"))
head(allAles)

set.seed(6)
perc=.8
trainIndices = sample(1:dim(allAles)[1],round(perc * dim(allAles)[1]))
train = allAles[trainIndices,]
test = allAles[-trainIndices,]
iterations=30

accs = data.frame(accuracy = numeric(iterations), k = numeric(iterations))

for(i in 1:iterations)
{
  classifications = knn(train[,c(2,3)],test[,c(2,3)],train$styleClass, prob = TRUE, k = i)
  table(test$styleClass,classifications)
  CM = confusionMatrix(table(test$styleClass,classifications))
  accs$accuracy[i] = CM$overall[1]
  accs$k[i] = i
}

plot(accs$k,accs$accuracy, type = "l")


plot(accs$k,accs$accuracy, type = "l", xlab = "k", ylab = "Accuracy", main = "K-factor vs Accuracy") 


#### Find optimal k-factor

iterations = 100
numks = 30

masterAcc = matrix(nrow = iterations, ncol = numks)

for(j in 1:iterations)
{
  accs = data.frame(accuracy = numeric(30), k = numeric(30))
  trainIndices = sample(1:dim(allAles)[1],round(perc * dim(allAles)[1]))
  train = allAles[trainIndices,]
  test = allAles[-trainIndices,]
  for(i in 1:numks)
  {
    classifications = knn(train[,c(2,3)],test[,c(2,3)],train$styleClass, prob = TRUE, k = i)
    table(test$styleClass,classifications)
    CM = confusionMatrix(table(test$styleClass,classifications))
    masterAcc[j,i] = CM$overall[1]
  }
}

MeanAcc = colMeans(masterAcc)

plot(seq(1,numks,1),MeanAcc, type = "l", xlab = "k", ylab = "Accuracy", main = "K-factor vs Accuracy")


k = 7






```



















